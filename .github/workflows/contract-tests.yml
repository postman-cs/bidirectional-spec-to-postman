name: Contract Tests

on:
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Test level to generate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - contract
      environment:
        description: 'Environment to run tests against'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  sync-and-test:
    runs-on: ubuntu-latest
    name: Sync to Spec Hub & Run Contract Tests
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate OpenAPI spec
        run: |
          echo "Validating OpenAPI spec..."
          npx @apidevtools/swagger-parser-cli validate specs/sample-api.yaml

      - name: Sync spec to Postman Spec Hub
        id: sync
        run: |
          echo "Syncing spec to Postman Spec Hub..."

          # Run sync and capture output
          node src/spec-hub-sync.js \
            --spec specs/sample-api.yaml \
            --test-level "${{ github.event.inputs.test_level || 'all' }}" \
            2>&1 | tee sync-output.txt

          # Extract spec name for later use
          SPEC_NAME=$(grep "Spec:" sync-output.txt | sed 's/.*Spec: //')
          echo "spec_name=$SPEC_NAME" >> "$GITHUB_OUTPUT"
          echo "Synced: $SPEC_NAME"

          # Determine which collections to run based on test level
          TEST_LEVEL="${{ github.event.inputs.test_level || 'all' }}"
          if [ "$TEST_LEVEL" = "all" ] || [ "$TEST_LEVEL" = "smoke" ]; then
            echo "run_smoke=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_smoke=false" >> "$GITHUB_OUTPUT"
          fi
          if [ "$TEST_LEVEL" = "all" ] || [ "$TEST_LEVEL" = "contract" ]; then
            echo "run_contract=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_contract=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}

      - name: Setup Postman CLI
        run: |
          echo "Installing Postman CLI..."
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
          postman --version

      - name: Login to Postman
        run: |
          echo "Logging in to Postman..."
          postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}

      - name: Run smoke tests
        id: smoke-tests
        if: steps.sync.outputs.run_smoke == 'true'
        run: |
          echo "Running smoke tests..."
          
          SPEC_NAME="${{ steps.sync.outputs.spec_name }}"
          ENV_NAME="$SPEC_NAME - ${{ github.event.inputs.environment || 'staging' }} server"
          
          # Get collection UID by name (more reliable than name)
          SMOKE_UID=$(postman collection list \
            --workspace ${{ secrets.POSTMAN_WORKSPACE_ID }} \
            --format json 2>/dev/null | \
            jq -r ".collections[] | select(.name == \"$SPEC_NAME - Smoke Tests\") | .uid")
          
          if [ -z "$SMOKE_UID" ]; then
            echo "❌ Smoke test collection not found"
            exit 1
          fi
          
          echo "Collection UID: $SMOKE_UID"
          echo "Environment: $ENV_NAME"
          
          # Update environment with auth token
          postman environment update "$ENV_NAME" \
            --variable auth_token="${{ secrets.API_AUTH_TOKEN }}" \
            --workspace ${{ secrets.POSTMAN_WORKSPACE_ID }}
          
          # Run smoke tests by UID
          postman collection run "$SMOKE_UID" \
            --environment "$ENV_NAME" \
            --reporters cli,junit \
            --reporter-junit-export smoke-results.xml \
            --verbose
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        continue-on-error: true

      - name: Run contract tests
        id: contract-tests
        if: steps.sync.outputs.run_contract == 'true'
        run: |
          echo "Running contract tests..."
          
          SPEC_NAME="${{ steps.sync.outputs.spec_name }}"
          ENV_NAME="$SPEC_NAME - ${{ github.event.inputs.environment || 'staging' }} server"
          
          # Get collection UID by name
          CONTRACT_UID=$(postman collection list \
            --workspace ${{ secrets.POSTMAN_WORKSPACE_ID }} \
            --format json 2>/dev/null | \
            jq -r ".collections[] | select(.name == \"$SPEC_NAME - Contract Tests\") | .uid")
          
          if [ -z "$CONTRACT_UID" ]; then
            echo "❌ Contract test collection not found"
            exit 1
          fi
          
          echo "Collection UID: $CONTRACT_UID"
          echo "Environment: $ENV_NAME"
          
          # Update environment with auth token
          postman environment update "$ENV_NAME" \
            --variable auth_token="${{ secrets.API_AUTH_TOKEN }}" \
            --workspace ${{ secrets.POSTMAN_WORKSPACE_ID }}
          
          # Run contract tests by UID
          postman collection run "$CONTRACT_UID" \
            --environment "$ENV_NAME" \
            --reporters cli,junit \
            --reporter-junit-export contract-results.xml \
            --verbose
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_id }}
          path: |
            smoke-results.xml
            contract-results.xml
            sync-output.txt
          retention-days: 30

      - name: Fail workflow if tests failed
        if: |
          (steps.smoke-tests.outcome == 'failure' && steps.sync.outputs.run_smoke == 'true') ||
          (steps.contract-tests.outcome == 'failure' && steps.sync.outputs.run_contract == 'true')
        run: |
          echo "❌ Tests failed!"
          exit 1
